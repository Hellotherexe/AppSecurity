@{
    ViewData["Title"] = "Forgot Password - Bookworms Online";
}

@inject Microsoft.Extensions.Options.IOptions<BookwormsOnline.Configuration.ReCaptchaSettings> ReCaptchaSettings
@{
    var siteKey = ReCaptchaSettings.Value.SiteKey;
}

<div class="row">
    <div class="col-md-6 offset-md-3">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0"><i class="bi bi-key"></i> Forgot Password</h2>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Enter your email address and we'll send you a link to reset your password.
                </p>

                <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

                <form asp-action="ForgotPassword" method="post" id="forgotPasswordForm">
                    @Html.AntiForgeryToken()
                    
                    <!-- reCAPTCHA v3 hidden token field -->
                    <input type="hidden" id="recaptchaToken" name="recaptchaToken" />

                    <div class="form-group mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" 
                               class="form-control" 
                               id="email" 
                               name="email"
                               required
                               placeholder="your.email@example.com" />
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-envelope"></i> Send Reset Link
                        </button>
                    </div>
                </form>

                <hr />

                <div class="text-center">
                    <a asp-action="Login" class="btn btn-link">
                        <i class="bi bi-arrow-left"></i> Back to Login
                    </a>
                </div>
            </div>
        </div>

        <div class="alert alert-info mt-4">
            <h6><i class="bi bi-info-circle"></i> Important Notes</h6>
            <ul class="mb-0">
                <li>The reset link will expire after 24 hours</li>
                <li>For security, we won't reveal if the email exists in our system</li>
                <li>Check your spam folder if you don't receive the email</li>
            </ul>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Google reCAPTCHA v3 -->
    <script src="https://www.google.com/recaptcha/api.js?render=@siteKey"></script>
    
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('forgotPasswordForm');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }
                
                // Execute reCAPTCHA v3 (required)
                if (typeof grecaptcha === 'undefined') {
                    alert('reCAPTCHA is not available. Please disable any adblocker or privacy extension and reload the page.');
                    return;
                }

                grecaptcha.ready(function() {
                    grecaptcha.execute('@siteKey', {action: 'forgotpassword'}).then(function(token) {
                        document.getElementById('recaptchaToken').value = token;
                        form.submit();
                    }).catch(function(error) {
                        console.error('reCAPTCHA error:', error);
                        alert('reCAPTCHA verification failed. Please refresh the page and try again.');
                    });
                });
            });
        });
    </script>
}

